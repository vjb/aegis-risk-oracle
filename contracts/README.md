# â›“ï¸ Aegis Vault (Solidity Contracts)

> **"The Final Guardian."**

The `AegisVault.sol` contract is the on-chain enforcement layer of the protocol. It ensures that no transaction can be executed without a cryptographically valid signature from the Aegis Decentralized Oracle Network (DON).

---

## ðŸ”’ Security Mechanics

1.  **Signature Verification (`ecrecover`)**:
    - The contract verifies that the provided signature matches the `riskHash` and was signed by a whitelisted `oracle` address.
2.  **Replay Protection (`salt` + `processedSalts`)**:
    - Every verdict includes a unique 32-byte salt generated by the DON.
    - Once a salt is used, it is marked as `processed` to prevent replay attacks.
3.  **Risk Threshold Enforcement**:
    - The contract checks the `riskScore` (0-10) against a maximum allowed threshold (default: 7).
    - If `riskScore >= 7`, the transaction reverts even if the signature is valid.
4.  **Expiry Time**:
    - Signatures include a timestamp and are only valid for a specific window (e.g., 5 minutes).

---

## ðŸ“œ Key Functions

### `swapWithOracle(...)`
Executes a token swap if and only if:
- The Oracle signature is valid.
- The risk score is within acceptable limits.
- The verdict is `EXECUTE`.
- The timestamp is fresh.

### `updateOracle(address)`
Allows the contract owner to rotate the authorized signer key (e.g., in case of key compromise or DON rotation).

---

## ðŸ§ª Testing

This contract is tested extensively using Foundry/Anvil. See [`tests/test-contract.ps1`](../tests/test-contract.ps1) for the full test suite.
